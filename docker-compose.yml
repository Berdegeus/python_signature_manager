version: "3.9"

x-shared-env: &shared-env
  JWT_SECRET: ${JWT_SECRET:-local-dev-secret}
  SQLITE_PATH: /app/data/capitalia.db

services:
  capitalia:
    build:
      context: ./services/capitalia
      dockerfile: Dockerfile
    environment:
      <<: *shared-env
      DB_KIND: ${DB_KIND:-sqlite}
      PORT: 8080
    volumes:
      - capitalia_data:/app/data
      - ./services/capitalia:/app/services/capitalia
      - ./libs/python:/app/libs/python
    restart: unless-stopped
    healthcheck:
      test:
        ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8080/health').read()"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    networks:
      - backend

  router:
    build:
      context: ./services/router
      dockerfile: Dockerfile
    environment:
      BACKEND_HOST: capitalia
      BACKEND_PORT: 8080
      ROUTER_PORT: 80
    depends_on:
      - capitalia
    ports:
      - "80:80"
    volumes:
      - ./services/router:/app/services/router
    restart: unless-stopped
    healthcheck:
      test:
        ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:80/health').read()"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    networks:
      - edge
      - backend

  purchase_requests:
    build:
      context: ./services/purchase_requests
      dockerfile: Dockerfile
    environment:
      ASPNETCORE_ENVIRONMENT: Development
      ConnectionStrings__DefaultConnection: "Data Source=/app/data/purchase_requests.db"
      Consul__Address: ${CONSUL_ADDRESS:-http://consul:8500}
    ports:
      - "5000:5000"
    volumes:
      - purchase_requests_data:/app/data
      - ./services/purchase_requests/appsettings.json:/app/appsettings.json:ro
    restart: unless-stopped
    networks:
      - backend

networks:
  backend:
  edge:

volumes:
  capitalia_data:
  purchase_requests_data:
